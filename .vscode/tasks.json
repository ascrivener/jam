{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Run Optimized State Tests",
            "type": "shell",
            "command": "cd ${workspaceFolder}/go && go test -c -o state.test ./state -gcflags=all=-B && ./state.test -test.run=TestStateDeserializerWithTransition",
            "group": {
                "kind": "test",
                "isDefault": true
            },
            "presentation": {
                "reveal": "always",
                "panel": "shared",
                "clear": true
            },
            "problemMatcher": []
        },
        {
            "label": "select-constants-generator",
            "type": "shell",
            "command": "if [ \"${input:testSize}\" = \"tiny\" ]; then echo \"Using tiny test vectors with test constants\" && cd ${workspaceFolder}/src/go/pkg/constants && JAM_USE_TEST_CONSTANTS=true go run constants_gen.go; else echo \"Using full test vectors with production constants\" && cd ${workspaceFolder}/src/go/pkg/constants && go run constants_gen.go; fi",
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            },
            "problemMatcher": []
        },
        {
            "label": "Run Fuzzer Tests",
            "dependsOrder": "sequence",
            "dependsOn": [
                "Build FuzzClient",
                "Build FuzzServer",
                "Start FuzzServer",
                "Wait For Server",
                "Run FuzzClient",
                "Cleanup"
            ],
            "group": {
                "kind": "test",
                "isDefault": true
            },
            "presentation": {
                "reveal": "always",
                "panel": "new"
            }
        },
        {
            "label": "Build FuzzClient",
            "type": "shell",
            "command": "cd ${workspaceFolder}/src/go/cmd/fuzzclient && go build -ldflags=\"-s -w\" .",
            "group": "build",
            "presentation": {
                "reveal": "silent"
            }
        },
        {
            "label": "Build FuzzServer",
            "type": "shell",
            "command": "cd ${workspaceFolder}/src/go/cmd/fuzzserver && go build -ldflags=\"-s -w\" .",
            "group": "build",
            "presentation": {
                "reveal": "silent"
            }
        },
        {
            "label": "Start FuzzServer",
            "type": "shell",
            "command": "cd ${workspaceFolder}/src/go/cmd/fuzzserver && ./fuzzserver",
            "isBackground": true,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^.*$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": "JAM Fuzzer Interface Server",
                    "endsPattern": "."
                }
            }
        },
        {
            "label": "Wait For Server",
            "type": "shell",
            "command": "sleep 2",
            "presentation": {
                "reveal": "silent"
            }
        },
        {
            "label": "Run FuzzClient",
            "type": "shell",
            "command": "cd ${workspaceFolder}/src/go/cmd/fuzzclient && ./fuzzclient -vectors ${input:vectorsDir}",
            "presentation": {
                "reveal": "always"
            }
        },
        {
            "label": "Cleanup",
            "type": "shell",
            "command": "pkill -f fuzzserver || true && rm -f ${workspaceFolder}/src/go/cmd/fuzzclient/fuzzclient ${workspaceFolder}/src/go/cmd/fuzzserver/fuzzserver && rm -rf ${workspaceFolder}/src/go/cmd/fuzzserver/data/",
            "presentation": {
                "reveal": "silent"
            }
        },
        // Docker fuzzer tasks (modular approach)
        {
            "label": "1. Build Binaries",
            "type": "shell",
            "command": "./build.sh",
            "group": "build",
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            },
            "problemMatcher": []
        },
        {
            "label": "2. Build Docker Image",
            "type": "shell",
            "command": "docker build -t jam-fuzzer -f src/go/cmd/fuzzer/Dockerfile .",
            "group": "build",
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            },
            "problemMatcher": []
        },
        {
            "label": "3. Run Docker Test (Selected Vector)",
            "type": "shell",
            "command": "docker run --rm -e TEST_VECTORS=${input:dockerTestVectors} jam-fuzzer",
            "group": "test",
            "presentation": {
                "reveal": "always",
                "panel": "dedicated"
            },
            "problemMatcher": []
        },
        {
            "label": "4. Run All Test Vectors",
            "type": "shell",
            "command": "echo 'Running all test vector sets...' && docker run --rm -e TEST_VECTORS=fallback jam-fuzzer && echo '\\n\\n==== COMPLETED fallback ====\\n\\n' && docker run --rm -e TEST_VECTORS=preimages jam-fuzzer && echo '\\n\\n==== COMPLETED preimages ====\\n\\n' && docker run --rm -e TEST_VECTORS=preimages_light jam-fuzzer && echo '\\n\\n==== COMPLETED preimages_light ====\\n\\n' && docker run --rm -e TEST_VECTORS=safrole jam-fuzzer && echo '\\n\\n==== COMPLETED safrole ====\\n\\n' && docker run --rm -e TEST_VECTORS=storage jam-fuzzer && echo '\\n\\n==== COMPLETED storage ====\\n\\n' && docker run --rm -e TEST_VECTORS=storage_light jam-fuzzer && echo '\\n\\n==== COMPLETED storage_light ====\\n\\n' && echo 'All test vector sets completed!'",
            "group": "test",
            "presentation": {
                "reveal": "always",
                "panel": "dedicated"
            },
            "problemMatcher": []
        },
        {
            "label": "5. Clean Docker Binaries",
            "type": "shell",
            "command": "echo 'Cleaning up Docker binaries...' && rm -f ${workspaceFolder}/src/go/cmd/fuzzer/fuzzserver/fuzzserver* && rm -f ${workspaceFolder}/src/go/cmd/fuzzer/fuzzclient/fuzzclient* && rm -rf /tmp/jam_crossbuild && echo 'Binaries cleanup completed'",
            "group": "test",
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            },
            "problemMatcher": []
        },
        // Composite tasks (using dependencies)
        {
            "label": "Run Docker Test (With Build)",
            "dependsOrder": "sequence",
            "dependsOn": [
                "1. Build Binaries",
                "2. Build Docker Image",
                "3. Run Docker Test (Selected Vector)",
                "5. Clean Docker Binaries"
            ],
            "group": "test",
            "problemMatcher": []
        },
        {
            "label": "Run All Docker Tests (With Build)",
            "dependsOrder": "sequence",
            "dependsOn": [
                "1. Build Binaries",
                "2. Build Docker Image",
                "4. Run All Test Vectors",
                // "5. Clean Docker Binaries"
            ],
            "group": {
                "kind": "test",
                "isDefault": true
            },
            "problemMatcher": []
        }
    ],
    "inputs": [
        {
            "id": "testSize",
            "type": "pickString",
            "description": "Choose test size (tiny=test constants, full=prod constants)",
            "options": [
                "tiny",
                "full"
            ],
            "default": "tiny"
        },
        {
            "id": "vectorsDir",
            "type": "pickString",
            "description": "Choose test vector directory",
            "default": "reports-l0",
            "options": [
                "/Users/adamscrivener/Projects/Jam/jam-test-vectors/traces/reports-l0",
                "/Users/adamscrivener/Projects/Jam/jam-test-vectors/traces/reports-l1",
                "/Users/adamscrivener/Projects/Jam/jam-test-vectors/traces/fallback",
                "/Users/adamscrivener/Projects/Jam/jam-test-vectors/traces/safrole"
            ]
        },
        {
            "id": "dockerTestVectors",
            "type": "pickString",
            "description": "Choose test vector set for Docker test",
            "default": "reports-l1",
            "options": [
                "reports-l0",
                "reports-l1",
                "safrole",
                "fallback"
            ]
        }
    ]
}