name: Daily OTS Timestamp

on:
  schedule:
    # Run daily at 12:00 UTC
    - cron: '0 12 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  actions: read

jobs:
  timestamp-commits:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history
        token: ${{ secrets.BOT_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install OpenTimestamps
      run: |
        pip install opentimestamps-client
    
    - name: Generate commit hash list
      run: |
        # Get all commit hashes in chronological order (oldest first)
        git log --reverse --pretty=format:"%H" > commits.txt
        echo "Generated commit list with $(wc -l < commits.txt) commits"
    
    - name: Generate SHA256 hash
      run: |
        # Create SHA256 hash of commit list
        sha256sum commits.txt | cut -d' ' -f1 > commits.sha256
        echo "SHA256 hash: $(cat commits.sha256)"
    
    - name: Create OpenTimestamps proof
      run: |
        # Create OTS timestamp
        ots stamp commits.sha256
        echo "Created OTS timestamp: commits.sha256.ots"
    
    - name: Commit and push timestamp files
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Create timestamp directory with precise time
        TIMESTAMP_DIR=".timestamps/$(date -u +%Y-%m-%d_%H-%M-%S_UTC)"
        mkdir -p "$TIMESTAMP_DIR"
        
        # Copy files to timestamp directory with precise time
        cp commits.txt "$TIMESTAMP_DIR/"
        cp commits.sha256 "$TIMESTAMP_DIR/"
        cp commits.sha256.ots "$TIMESTAMP_DIR/"
        
        # Also keep latest in root for easy access
        cp commits.sha256.ots ./latest-commits.sha256.ots
        
        # Add and commit with precise timestamp
        git add .timestamps/ latest-commits.sha256.ots
        git commit -m "Daily OTS timestamp: $(date -u +%Y-%m-%d_%H:%M:%S_UTC)" || echo "No changes to commit"
        git push
